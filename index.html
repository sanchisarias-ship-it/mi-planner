<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Mi Planner Saludable</title>
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<style>
body { font-family:-apple-system,BlinkMacSystemFont,Arial,sans-serif; margin:0; background:#f4f9ff; }
header { background:linear-gradient(135deg,#00c6ff,#0072ff); color:white; padding:16px; text-align:center; }
nav { display:flex; background:#0d2b45; }
nav button { flex:1; padding:12px; border:none; background:#0d2b45; color:white; font-size:15px; }
nav button.active { background:#123e63; }
section { display:none; padding:14px; }
section.active { display:block; }
.card { background:white; padding:14px; border-radius:16px; margin-bottom:12px; box-shadow:0 4px 8px rgba(0,0,0,.06); }

.grid { display:grid; grid-template-columns:repeat(7,1fr); gap:6px; }
.day { background:#e9f1f9; padding:10px; border-radius:12px; text-align:center; font-size:13px; cursor:pointer; }
.today { border:2px solid #0072ff; }
.event { background:#eef7ff; padding:6px 10px; border-radius:10px; margin:6px 0; font-size:14px; }

.weekdays { display:grid; grid-template-columns:repeat(7,1fr); font-size:12px; font-weight:bold; text-align:center; margin-bottom:6px; }

li { list-style:none; display:flex; align-items:center; gap:8px; background:#f9fcff; padding:6px 10px; border-radius:10px; margin-bottom:4px; }
li span { flex:1; }
li.checked { text-decoration: line-through; background:#dffbe7; }

input, button { padding:10px; border-radius:10px; border:1px solid #ccc; font-size:16px; }
button.primary { background:#0072ff; color:white; border:none; }
table { width:100%; border-collapse:collapse; }
td, th { padding:8px; border-bottom:1px solid #eee; text-align:left; font-size:14px; }
.small { font-size:13px; color:#666; }
</style>
</head>
<body>

<header><h1>üö¥‚Äç‚ôÇÔ∏è Mi Planner Saludable</h1></header>

<nav>
  <button class="active" onclick="showTab('hoy',this)">Hoy</button>
  <button onclick="showTab('calendario',this)">Calendario</button>
  <button onclick="showTab('alimentos',this)">Alimentos</button>
  <button onclick="showTab('seguimiento',this)">Seguimiento</button>
</nav>

<section id="hoy" class="active">
  <div class="card">
    <h3>Hoy</h3>
    <div id="todayEvents">Cargando...</div>
  </div>
</section>

<section id="calendario">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <button onclick="prevMonth()">‚óÄ</button>
      <strong id="monthLabel"></strong>
      <button onclick="nextMonth()">‚ñ∂</button>
    </div>
    <div class="weekdays">
      <div>L</div><div>M</div><div>X</div><div>J</div><div>V</div><div>S</div><div>D</div>
    </div>
    <div id="calendar" class="grid"></div>
  </div>

  <div class="card">
    <h3 id="selectedDate">Selecciona un d√≠a</h3>
    <div id="dayEvents"></div>
  </div>
</section>

<section id="alimentos">
  <div class="card" id="foodContainer">Cargando alimentos...</div>
</section>

<section id="seguimiento">
  <div class="card">
    <h3>üìà Seguimiento de peso</h3>
    <p class="small">Introduce tu peso una vez al d√≠a para llevar un control de evoluci√≥n.</p>

    <div style="display:flex; gap:8px; margin-bottom:10px;">
      <input type="number" step="0.1" id="pesoInput" placeholder="Peso (kg)">
      <button class="primary" onclick="guardarPeso()">Guardar</button>
    </div>

    <div id="stats" class="small"></div>
  </div>

  <div class="card">
    <h3>Historial</h3>
    <table>
      <thead><tr><th>Fecha</th><th>Peso</th><th></th></tr></thead>
      <tbody id="tablaPesos"></tbody>
    </table>
  </div>
</section>

<script>
let eventsByDate = {};
let current = new Date();

function showTab(id,btn){
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  btn.classList.add("active");
}

// ---------- CALENDARIO ICS ----------
async function loadICS(){
  try{
    const res = await fetch("plan_anual_completo_365_dias.ics");
    const text = await res.text();
    parseICS(text);
    renderToday();
    renderCalendar();
  }catch(e){
    document.getElementById("todayEvents").innerHTML = "No se pudo cargar el calendario.";
  }
}

function parseICS(text){
  const blocks = text.split("BEGIN:VEVENT");
  blocks.forEach(b=>{
    if(!b.includes("SUMMARY")) return;
    const summary = (b.match(/SUMMARY:(.+)/)||[])[1];
    const dt = (b.match(/DTSTART:(\d{8})T(\d{6})/)||[]);
    if(!summary || !dt[1]) return;
    const date = dt[1].slice(0,4)+"-"+dt[1].slice(4,6)+"-"+dt[1].slice(6,8);
    const time = dt[2].slice(0,2)+":"+dt[2].slice(2,4);
    if(!eventsByDate[date]) eventsByDate[date]=[];
    eventsByDate[date].push(time+" - "+summary);
  });
}

function renderToday(){
  const today = new Date().toISOString().slice(0,10);
  const cont = document.getElementById("todayEvents");
  cont.innerHTML = "";
  (eventsByDate[today]||["Sin eventos"]).forEach(e=>{
    cont.innerHTML += "<div class='event'>"+e+"</div>";
  });
}

function renderCalendar(){
  const y=current.getFullYear(), m=current.getMonth();
  document.getElementById("monthLabel").innerText =
    current.toLocaleDateString("es-ES",{month:"long",year:"numeric"});

  const first=(new Date(y,m,1).getDay()+6)%7;
  const days=new Date(y,m+1,0).getDate();
  const cal=document.getElementById("calendar");
  cal.innerHTML="";
  for(let i=0;i<first;i++) cal.innerHTML+="<div></div>";

  for(let d=1;d<=days;d++){
    const date=y+"-"+String(m+1).padStart(2,"0")+"-"+String(d).padStart(2,"0");
    const todayClass = date===new Date().toISOString().slice(0,10) ? "today" : "";
    cal.innerHTML+=`<div class="day ${todayClass}" onclick="showDay('${date}')">${d}</div>`;
  }
}

function showDay(date){
  document.getElementById("selectedDate").innerText = date;
  const cont=document.getElementById("dayEvents");
  cont.innerHTML="";
  (eventsByDate[date]||["Sin eventos"]).forEach(e=>{
    cont.innerHTML += "<div class='event'>"+e+"</div>";
  });
}

function prevMonth(){ current.setMonth(current.getMonth()-1); renderCalendar(); }
function nextMonth(){ current.setMonth(current.getMonth()+1); renderCalendar(); }

// ---------- ALIMENTOS ----------
async function loadFoods(){
  try{
    const res = await fetch("ALIMENTOS SALUDABLES.json");
    const data = await res.json();
    const cont = document.getElementById("foodContainer");
    cont.innerHTML = "";
    Object.keys(data).forEach(cat=>{
      cont.innerHTML += `<h3>${cat}</h3>`;
      data[cat].forEach(item=>{
        const key = cat+"_"+item;
        const checked = localStorage.getItem(key) ? "checked" : "";
        const cls = localStorage.getItem(key) ? "checked" : "";
        cont.innerHTML += `
          <li class="${cls}">
            <input type="checkbox" onchange="toggleFood('${key}', this)" ${checked}>
            <span>${item}</span>
          </li>`;
      });
    });
  }catch(e){
    document.getElementById("foodContainer").innerHTML = "No se pudieron cargar los alimentos.";
  }
}

function toggleFood(key,cb){
  if(cb.checked) localStorage.setItem(key,"1");
  else localStorage.removeItem(key);
  loadFoods();
}

// ---------- SEGUIMIENTO PESO ----------
function guardarPeso(){
  const input = document.getElementById("pesoInput");
  const valor = parseFloat(input.value);
  if(!valor) return alert("Introduce un peso v√°lido");

  const hoy = new Date().toISOString().slice(0,10);
  let data = JSON.parse(localStorage.getItem("pesos")||"{}");
  data[hoy] = valor;
  localStorage.setItem("pesos", JSON.stringify(data));
  input.value = "";
  renderPesos();
}

function borrarPeso(fecha){
  let data = JSON.parse(localStorage.getItem("pesos")||"{}");
  delete data[fecha];
  localStorage.setItem("pesos", JSON.stringify(data));
  renderPesos();
}

function renderPesos(){
  const tbody = document.getElementById("tablaPesos");
  const stats = document.getElementById("stats");
  let data = JSON.parse(localStorage.getItem("pesos")||"{}");

  const fechas = Object.keys(data).sort();
  tbody.innerHTML = "";

  fechas.forEach(f=>{
    tbody.innerHTML += `<tr>
      <td>${f}</td>
      <td>${data[f]} kg</td>
      <td><button onclick="borrarPeso('${f}')">‚ùå</button></td>
    </tr>`;
  });

  if(fechas.length > 1){
    const primero = data[fechas[0]];
    const ultimo = data[fechas[fechas.length-1]];
    const diff = (ultimo - primero).toFixed(1);
    stats.innerHTML = "Evoluci√≥n: " + (diff>0? "+"+diff: diff) + " kg desde el inicio.";
  } else {
    stats.innerHTML = "";
  }
}

loadICS();
loadFoods();
renderPesos();
</script>
</body>
</html>
