<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Mi Planner Saludable</title>
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family:-apple-system,BlinkMacSystemFont,Arial,sans-serif; margin:0; background:#f4f9ff; }
header { background:linear-gradient(135deg,#00c6ff,#0072ff); color:white; padding:12px; text-align:center; display:flex; align-items:center; justify-content:center; gap:12px;}
header img { width:48px; height:48px; border-radius:12px; }
nav { display:flex; background:#0d2b45; }
nav button { flex:1; padding:12px; border:none; background:#0d2b45; color:white; font-size:14px; }
nav button.active { background:#123e63; }
section { display:none; padding:14px; }
section.active { display:block; }
.card { background:white; padding:14px; border-radius:16px; margin-bottom:12px; box-shadow:0 4px 8px rgba(0,0,0,.06); }

.grid { display:grid; grid-template-columns:repeat(7,1fr); gap:6px; }
.day { background:#e9f1f9; padding:10px; border-radius:12px; text-align:center; font-size:13px; cursor:pointer; }
.today { border:2px solid #0072ff; }
.event { background:#eef7ff; padding:6px 10px; border-radius:10px; margin:6px 0; font-size:14px; }

.weekdays { display:grid; grid-template-columns:repeat(7,1fr); font-size:12px; font-weight:bold; text-align:center; margin-bottom:6px; }

li { list-style:none; display:flex; align-items:center; gap:8px; background:#f9fcff; padding:6px 10px; border-radius:10px; margin-bottom:4px; }
li span { flex:1; }
li.checked { text-decoration: line-through; background:#dffbe7; opacity:0.8; }

input, button, select { padding:10px; border-radius:10px; border:1px solid #ccc; font-size:15px; }
button.primary { background:#0072ff; color:white; border:none; }
.small { font-size:13px; color:#666; }

.stats-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; text-align:center; }
.stat { background:#eef7ff; padding:10px; border-radius:12px; font-weight:bold; }

table { width:100%; border-collapse:collapse; }
td, th { padding:6px; border-bottom:1px solid #eee; font-size:14px; text-align:left; }
</style>
</head>
<body>

<header>
  <img src="apple-touch-icon.png" alt="Icono">
  <h2>Mi Planner Saludable</h2>
</header>

<nav>
  <button class="active" onclick="showTab('hoy',this)">Hoy</button>
  <button onclick="showTab('calendario',this)">Calendario</button>
  <button onclick="showTab('alimentos',this)">Alimentos</button>
  <button onclick="showTab('compra',this)">Lista compra</button>
  <button onclick="showTab('seguimiento',this)">Seguimiento</button>
</nav>

<section id="hoy" class="active">
  <div class="card"><h3>Hoy</h3><div id="todayEvents">Cargando...</div></div>
</section>

<section id="calendario">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <button onclick="prevMonth()">‚óÄ</button>
      <strong id="monthLabel"></strong>
      <button onclick="nextMonth()">‚ñ∂</button>
    </div>
    <div class="weekdays"><div>L</div><div>M</div><div>X</div><div>J</div><div>V</div><div>S</div><div>D</div></div>
    <div id="calendar" class="grid"></div>
  </div>
  <div class="card"><h3 id="selectedDate">Selecciona un d√≠a</h3><div id="dayEvents"></div></div>
</section>

<section id="alimentos">
  <div class="card">
    <h3>‚ûï A√±adir alimento</h3>
    <div style="display:flex; gap:6px; flex-wrap:wrap;">
      <input id="nuevoAlimento" placeholder="Ej: Aguacate">
      <select id="categoriaSelect"></select>
      <button class="primary" onclick="addFood()">A√±adir</button>
    </div>
    <p class="small">Marca los alimentos para usarlos como lista r√°pida.</p>
  </div>
  <div class="card" id="foodContainer">Cargando alimentos...</div>
</section>

<section id="compra">
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <button onclick="cambiarSemana(-1)">‚óÄ Semana</button>
      <strong id="weekLabel"></strong>
      <button onclick="cambiarSemana(1)">Semana ‚ñ∂</button>
    </div>
  </div>
  <div class="card" id="listaCompra">Calculando lista...</div>
</section>

<section id="seguimiento">
  <div class="card">
    <h3>üìà Seguimiento de peso</h3>
    <div style="display:flex; gap:8px; margin-bottom:10px;">
      <input type="number" step="0.1" id="pesoInput" placeholder="Peso (kg)">
      <button class="primary" onclick="guardarPeso()">Guardar</button>
    </div>
  </div>

  <div class="card"><canvas id="pesoChart" height="120"></canvas></div>

  <div class="card">
    <h3>Medias</h3>
    <div class="stats-grid">
      <div class="stat" id="mediaSemanal">Semanal: -</div>
      <div class="stat" id="mediaMensual">Mensual: -</div>
      <div class="stat" id="mediaAnual">Anual: -</div>
    </div>
  </div>

  <div class="card">
    <h3>Registros</h3>
    <table>
      <thead><tr><th>Fecha</th><th>Peso</th><th></th></tr></thead>
      <tbody id="tablaPesos"></tbody>
    </table>
  </div>
</section>

<script>
let eventsByDate = {};
let current = new Date();
let chart;
let alimentosData = {};
let weekOffset = 0;

function showTab(id,btn){
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  btn.classList.add("active");
}

// --------- ICS ----------
async function loadICS(){
  try{
    const res = await fetch("plan_anual_completo_365_dias.ics");
    const text = await res.text();
    const blocks = text.split("BEGIN:VEVENT");
    blocks.forEach(b=>{
      const summary = (b.match(/SUMMARY:(.+)/)||[])[1];
      const dt = (b.match(/DTSTART:(\d{8})T(\d{6})/)||[]);
      if(!summary||!dt[1]) return;
      const date = dt[1].slice(0,4)+"-"+dt[1].slice(4,6)+"-"+dt[1].slice(6,8);
      const time = dt[2].slice(0,2)+":"+dt[2].slice(2,4);
      if(!eventsByDate[date]) eventsByDate[date]=[];
      eventsByDate[date].push(time+" - "+summary);
    });
    renderToday(); renderCalendar(); renderCompra();
  }catch(e){}
}

function renderToday(){
  const today = new Date().toISOString().slice(0,10);
  const cont = document.getElementById("todayEvents");
  cont.innerHTML="";
  (eventsByDate[today]||["Sin eventos"]).forEach(e=> cont.innerHTML += "<div class='event'>"+e+"</div>");
}

function renderCalendar(){
  const y=current.getFullYear(), m=current.getMonth();
  document.getElementById("monthLabel").innerText =
    current.toLocaleDateString("es-ES",{month:"long",year:"numeric"});
  const first=(new Date(y,m,1).getDay()+6)%7;
  const days=new Date(y,m+1,0).getDate();
  const cal=document.getElementById("calendar");
  cal.innerHTML="";
  for(let i=0;i<first;i++) cal.innerHTML+="<div></div>";
  for(let d=1;d<=days;d++){
    const date=y+"-"+String(m+1).padStart(2,"0")+"-"+String(d).padStart(2,"0");
    const todayClass = date===new Date().toISOString().slice(0,10) ? "today" : "";
    cal.innerHTML+=`<div class="day ${todayClass}" onclick="showDay('${date}')">${d}</div>`;
  }
}

function showDay(date){
  document.getElementById("selectedDate").innerText = date;
  const cont=document.getElementById("dayEvents");
  cont.innerHTML="";
  (eventsByDate[date]||["Sin eventos"]).forEach(e=> cont.innerHTML += "<div class='event'>"+e+"</div>");
}

function prevMonth(){ current.setMonth(current.getMonth()-1); renderCalendar(); }
function nextMonth(){ current.setMonth(current.getMonth()+1); renderCalendar(); }

// -------- ALIMENTOS --------
async function loadFoods(){
  try{
    const local = localStorage.getItem("alimentosData");
    if(local){
      alimentosData = JSON.parse(local);
    } else {
      const res = await fetch("ALIMENTOS SALUDABLES.json");
      alimentosData = await res.json();
      localStorage.setItem("alimentosData", JSON.stringify(alimentosData));
    }
    renderFoods();
  }catch(e){
    document.getElementById("foodContainer").innerHTML = "No se pudieron cargar alimentos.";
  }
}

function renderFoods(){
  const cont = document.getElementById("foodContainer");
  const select = document.getElementById("categoriaSelect");
  cont.innerHTML=""; select.innerHTML="";
  const checks = JSON.parse(localStorage.getItem("foodChecks")||"{}");

  Object.keys(alimentosData).forEach(cat=>{
    select.innerHTML += `<option value="${cat}">${cat}</option>`;
    cont.innerHTML += `<h3>${cat}</h3>`;
    alimentosData[cat].forEach((item,i)=>{
      const key = cat+"_"+item;
      const marcado = checks[key];
      cont.innerHTML += `<li class="${marcado?'checked':''}">
        <input type="checkbox" ${marcado?'checked':''} onchange="toggleCheck('${key}')">
        <span>${item}</span>
        <button onclick="removeFood('${cat}',${i})">üóëÔ∏è</button>
      </li>`;
    });
  });
}

function toggleCheck(key){
  let checks = JSON.parse(localStorage.getItem("foodChecks")||"{}");
  checks[key] = !checks[key];
  localStorage.setItem("foodChecks", JSON.stringify(checks));
  renderFoods();
}

function addFood(){
  const name = document.getElementById("nuevoAlimento").value.trim();
  const cat = document.getElementById("categoriaSelect").value;
  if(!name) return alert("Introduce un alimento");
  alimentosData[cat].push(name);
  localStorage.setItem("alimentosData", JSON.stringify(alimentosData));
  document.getElementById("nuevoAlimento").value="";
  renderFoods();
}

function removeFood(cat,index){
  alimentosData[cat].splice(index,1);
  localStorage.setItem("alimentosData", JSON.stringify(alimentosData));
  renderFoods();
}

// -------- LISTA COMPRA --------
function cambiarSemana(dir){ weekOffset += dir; renderCompra(); }

function inicioSemana(date){
  const d = new Date(date);
  const day = (d.getDay()+6)%7;
  d.setDate(d.getDate()-day);
  return d;
}

function renderCompra(){
  const base = inicioSemana(new Date());
  base.setDate(base.getDate() + weekOffset*7);
  const end = new Date(base); end.setDate(base.getDate()+6);

  document.getElementById("weekLabel").innerText =
    base.toLocaleDateString("es-ES") + " - " + end.toLocaleDateString("es-ES");

  const counts = {};
  for(let i=0;i<7;i++){
    const d = new Date(base); d.setDate(base.getDate()+i);
    const key = d.toISOString().slice(0,10);
    (eventsByDate[key]||[]).forEach(ev=>{
      if(ev.includes("Desayuno")||ev.includes("Comida")||ev.includes("Cena")||ev.includes("Merienda")||ev.includes("Media")){
        const foods = ev.split(":")[1]||"";
        foods.split(/[,+y]/i).forEach(f=>{
          const item = f.trim().toLowerCase();
          if(!item) return;
          counts[item] = (counts[item]||0)+1;
        });
      }
    });
  }

  const cont = document.getElementById("listaCompra");
  if(Object.keys(counts).length===0){ cont.innerHTML="Sin datos para esta semana"; return; }

  cont.innerHTML = "<h3>Lista semanal</h3>";
  Object.keys(counts).sort().forEach(item=>{
    cont.innerHTML += `<li><span>${item}</span><strong>x${counts[item]}</strong></li>`;
  });
}

// -------- PESO --------
function guardarPeso(){
  const v = parseFloat(document.getElementById("pesoInput").value);
  if(!v) return alert("Introduce peso v√°lido");
  const hoy = new Date().toISOString().slice(0,10);
  let data = JSON.parse(localStorage.getItem("pesos")||"{}");
  data[hoy]=v;
  localStorage.setItem("pesos",JSON.stringify(data));
  document.getElementById("pesoInput").value="";
  renderPesos();
}

function borrarPeso(fecha){
  let data = JSON.parse(localStorage.getItem("pesos")||"{}");
  delete data[fecha];
  localStorage.setItem("pesos",JSON.stringify(data));
  renderPesos();
}

function renderPesos(){
  const data = JSON.parse(localStorage.getItem("pesos")||"{}");
  const fechas = Object.keys(data).sort();
  const pesos = fechas.map(f=>data[f]);

  const tbody=document.getElementById("tablaPesos");
  tbody.innerHTML="";
  fechas.forEach(f=>{
    tbody.innerHTML += `<tr><td>${f}</td><td>${data[f]} kg</td><td><button onclick="borrarPeso('${f}')">‚ùå</button></td></tr>`;
  });

  if(chart) chart.destroy();
  chart=new Chart(document.getElementById("pesoChart"),{
    type:"line",
    data:{labels:fechas,datasets:[{data:pesos,fill:true,tension:0.3}]},
    options:{plugins:{legend:{display:false}}}
  });
  calcularMedias(fechas,pesos);
}

function calcularMedias(fechas,pesos){
  function avg(arr){return arr.length?(arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1):"-";}
  const now=new Date();
  const semanal=[], mensual=[], anual=[];
  fechas.forEach((f,i)=>{
    const d=new Date(f);
    const diff=(now-d)/(1000*3600*24);
    if(diff<=7) semanal.push(pesos[i]);
    if(diff<=30) mensual.push(pesos[i]);
    if(diff<=365) anual.push(pesos[i]);
  });
  document.getElementById("mediaSemanal").innerText="Semanal: "+avg(semanal)+" kg";
  document.getElementById("mediaMensual").innerText="Mensual: "+avg(mensual)+" kg";
  document.getElementById("mediaAnual").innerText="Anual: "+avg(anual)+" kg";
}

loadICS(); loadFoods(); renderPesos();
</script>
</body>
</html>
